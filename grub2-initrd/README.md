 Задание 5 курса "Администратор Linux" 
## Загрузка системы

    Работа с загрузчиком
    Цель: Зайти в систему без пароля рута - базовая задача сисадмина. Так же нужно уметь управлять поведением загрузчика.
    1. Попасть в систему без пароля несколькими способами
    2. Установить систему с LVM, после чего переименовать VG
    3. Добавить модуль в initrd

    
### 1. Попасть в систему без пароля:
Вариант 1 (Ubuntu 20.02)
- Попасть в систему для смены пароля можно успев до загрузки зайти в grub, нажав клавишу ```e```, после чего добавить к строке ```linux``` ```single init=/bin/bash``` после чего нажать ```Ctrl+X``` для начала загрузки системы [скрин шаг-1](img/step.JPG), [скрин шаг-2](img/step2.JPG)
- набрав команду ```mount``` видим, что система примонтирована в режиме чтения [скрин шаг-3](img/step3.JPG)
- Далее перемонтируем корень - ```mount -o remount,rw /```, теперь видим, что система примонтирована в режиме записи [скрин шаг-4](img/step4.JPG). Можем поменять пароль командой ```passwd```, далее проверяем включен для SELUX ```cat /etc/selinux/config```, если ```SELINUX=Enforcing```, то меняем или на ```Permissive``` или ```Disabled```, перезагружаемся
- Заходим в систему по новому паролю, если SELINUX включен, то делаем ```fixfilex -f relabel```


Вариант 2 (Ubuntu 20.02). Сразу монтируем систему в режиме rw.
- Попадаем в систему для смены пароля еак и в первом варианте успев до загрузки зайти в grub, нажав клавишу ```e```, после чего добавить к строке ```linux``` ```single init=/bin/bash``` и заменяем в этой же строке ```ro``` на ```rw```, после чего нажать ```Ctrl+X``` для начала загрузки системы [скрин шаг-1](img/step.JPG), [скрин шаг-2](img/step-1.JPG)
- набрав команду ```mount``` видим, что система примонтирована в режиме записи [скрин шаг-4](img/step-2.JPG). Можем поменять пароль командой ```passwd```, далее проверяем включен для SELUX ```cat /etc/selinux/config```, если ```SELINUX=Enforcing```, то меняем или на ```Permissive``` или ```Disabled```, перезагружаемся
- Заходим в систему по новому паролю, если SELINUX включен, то делаем ```fixfilex -f relabel```
* [Log работы на виртуальной машине файл typescript-full](typescript-full)

Вариант 3 (SentOS/7).
- Заходим в загрузчик до старта системы (перед тем, как начнется загрузка нужно успеть нажать на клашиву ```e```)
- Затем находим строку ```linux16``` и убираем из нее все значение ```console```, а частности: ```console=tty0 console=ttyS0,115200n8``` и добавляем ```rd.break```, далее нажимаем ```Ctrl+X```
- Произойдет загрузка системы в аварийном режиме, далее выполняем команду перемонтирования корня для чтения и записи - ```mount -o remount,rw /sysroot```, далее ```chroot /sysroot```
- Далее мы можем поменять пароль, выполнив команду ```passwd``` или ```passwd root```
- После смены пароля необходимо создать скрытый файл ```.autorelabel``` в /, выполнив ```touch /.autorelabel```, этот файл нужен, для того чтобы выполнить relabel файлов в системе, если selinux включен и находиться в режиме ```Enforcing```. Есди не выпключен, надо снова зайти в grub до загрузки системы, после чего в строке linux16 передать ядру параметр загрузки ```enforcing=0```, этот параметр говорит ядру, загрузить систему в режиме selinux=Permissive, в этом режиме система безопасности только лишь пишет в лог файл о найденных нарушениях в файлах, но не блокирует их работу.
- Загрузка произошла, теперь мы можем зайти под root, введя измененный пароль
* [скриншот шаг 1](img/seos-1.png)
* [скриншот шаг 2](img/seos-2.png)
* [скриншот шаг 3](img/seos-3.png)
* [скриншот шаг 4](img/seos-4.png)
* [скриншот шаг 5](img/seos-5.png)
* [скриншот шаг 6](img/seos-6.png)

### 2. Установить систему с LVM, после чего переименовать VG:
- Первым делом можем посмотреть какие Volume Group у нас есть командой ```vgs```
- Далее можем поменять название VG vgrename <Название которое есть сейчас> <Новое название>. Можем просмотреть новое название ```ls -l /dev/mapper```
- Далее будем править файлы, чтобы в дальнейшем мы могли загрузиться, первый файл это ```/etc/fstab```, заходим в него и меняем старое название на новое
- Далее заходим в файл ```/etc/default/grub``` и в строке ```GRUB_CMDLINE_LINUX``` изменяем старое название на новое в значениях ```rd.lvm.lv```
- Далее заходим в файл ```/boot/grub2/grub.cfg``` и меняем старые название на новое в строке ```linux16``` нужного меню
- Далее пересоздаем initrd image, в Centos 7 это не обязательно, так как система все равно загружается, однако делаем это чтобы в файлах initrd image поменялся путь монтирования, выполняем ```mkinitrd -f -v /boot/initramfs-$(uname -r).img $(uname -r)```.
- Перезагружаем компьютер, теперь у нас система загружается с новым названием VG. Также можно менять названия логических томов.
* [Измененный файл /etc/fstab](scripts/fstab)
* [Измененный файл /etc/default/grub](scripts/grub)
* [Измененный файл /boot/grub2/grub.cfg](scripts/grub.cfg)
* [Вывод в терминал результатов ввода команд](scripts/rename.txt)

### 3. Добавить модуль в initrd:

- Скрипты модулей хранятся в каталоге /usr/lib/dracut/modules.d/. Для того чтобы добавить свой модуль создаем там папку с именем 01test, ```mkdir /usr/lib/dracut/modules.d/01test```
- Далее создаем там 2 скрипта - ```module-setup.sh``` и ```test.sh```, делаем их исполняемыми ```chmod +x```. В скрипт ```module-setup.sh``` вписываем:
```
#!/bin/bash

check() { # Функция, которая указывает что модуль должен быть включен по умолчанию
    return 0
}

depends() { # Выводит все зависимости от которых зависит наш модуль
    return 0
}

install() {
    inst_hook cleanup 00 "${moddir}/test.sh" # Запускает скрипт
}
```
В файле ```test.sh```:
```
#!/bin/bash

cat <<'msgend'
Hello! You are in dracut module!
 ___________________
< I'm dracut module >
 -------------------
   \
    \
        .--.
       |o_o |
       |:_/ |
      //   \ \
     (|     | )
    /'\_   _/`\
    \___)=(___/
msgend
sleep 10
echo " continuing...."
```
- Далее выполняем команду ```dracut -f -v```
- Перезагружаемся и видим пингвина
* [файл /usr/lib/dracut/modules.d/01test/module-setup.sh](scripts/module-setup.sh)
* [файл /usr/lib/dracut/modules.d/01test/test.sh](scripts/test.sh)
* [Вывод пыполнения команд в консоль](scripts/initdr)
* [скриншот с результатом выполнения команд](img/screen.png)

